---
import Layout from "../layouts/layout.astro";
import { App } from "../app";
import { ACCESS_TOKEN_EXPIRATION_OFFSET_IN_MS, api } from "@/services";
import type { User } from "@/types";

const getAuth = async () => {
  const authCookie = Astro.cookies.get("auth");

  if (authCookie) {
    const { state } = authCookie.json();

    if (
      state.auth?.tokenExpirationTimestamp <
      Date.now() - ACCESS_TOKEN_EXPIRATION_OFFSET_IN_MS
    ) {
      // refresh token
      console.log("NEEDS TOKEN REFRESH");
    }

    return state.auth;
  }

  return null;
};

const getProfile = async () => {
  const auth = await getAuth();

  if (!auth) return null;

  return await api
    .get<User>("profile/me", {
      headers: {
        Authorization: `Bearer ${auth.accessToken}`,
      },
    })
    .json();
};

const profile = await getProfile();
---

<Layout>
  <App client:load initialPath="/profile" profile={profile} />
</Layout>
